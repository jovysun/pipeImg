"use strict";var _extends=Object.assign||function(t){for(var i=1;i<arguments.length;i++){var n=arguments[i];for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])}return t},_createClass=function(){function e(t,i){for(var n=0;n<i.length;n++){var e=i[n];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();function _classCallCheck(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}!function(t){function n(t){return"string"==typeof t?document.querySelector(t):t}function r(t,i){var n=new Image;n.setAttribute("crossorigin","anonymous"),n.src=t,n.onload=function(){"function"==typeof i&&i(n)},n.onerror=function(){console.log("Error: image error!")}}function k(t,i){var n=document.createElement("canvas");return n.width=t,n.height=i,n}var e={selectBtn:"#J-select-btn",upBtn:"#J-up-btn",downBtn:"#J-down-btn",anticlockwiseBtn:"#J-anticlockwise-btn",clockwiseBtn:"#J-clockwise-btn",cropBtn:"#J-crop-btn",downloadBtn:"#J-download-btn",workingContainer:"#J-working-container",previewContainer:"#J-preview-container",scaleStep:10,containerSize:500,cropW:300,cropH:300,mime:"image/png",maskColor:"rgba(0, 0, 0, 0.8)",hasMark:!0,markIcon:null,markFont:"16px microsoft yahei",markStyle:"#fff",markText:"UED",markX:0,markY:0,onValidateFile:function(t){},onCropped:function(t){}},i=function(){function i(t){_classCallCheck(this,i),this.options=_extends(e,t),this.$selectBtn=n(this.options.selectBtn),this.$upBtn=n(this.options.upBtn),this.$downBtn=n(this.options.downBtn),this.$anticlockwiseBtn=n(this.options.anticlockwiseBtn),this.$clockwiseBtn=n(this.options.clockwiseBtn),this.$cropBtn=n(this.options.cropBtn),this.$downloadBtn=n(this.options.downloadBtn),this.$workingContainer=n(this.options.workingContainer),this.$previewContainer=n(this.options.previewContainer),this.scaleStep=this.options.scaleStep,this.containerSize=this.options.containerSize,this.cropW=this.options.cropW<=this.containerSize?this.options.cropW:this.containerSize,this.cropH=this.options.cropH<=this.containerSize?this.options.cropH:this.containerSize,this.mime=this.options.mime,this.maskColor=this.options.maskColor,this.hasMark=this.options.hasMark,this.markIcon=this.options.markIcon,this.markFont=this.options.markFont,this.markStyle=this.options.markStyle,this.markText=this.options.markText,this.markX=this.options.markX,this.markY=this.options.markY,this.onValidateFile=this.options.onValidateFile,this.onCropped=this.options.onCropped,this.rotateCount=0,this.init()}return _createClass(i,[{key:"getRotateNum",value:function(t){return this.rotateCount+=t,(3<this.rotateCount||this.rotateCount<-3)&&(this.rotateCount=0),this.rotateCount<0?4+this.rotateCount:this.rotateCount}},{key:"rotate",value:function(t,u,f,m){r(t,function(t){var i=90*u,n=t.naturalWidth,e=t.naturalHeight,o=Math.max(n,e),r=k(o,o),a=r.getContext("2d");a.translate(o/2,o/2),a.rotate(i*Math.PI/180),a.translate(-o/2,-o/2),a.drawImage(t,0,0);var s=n,c=e,l=0,h=0;1===u?(c=n,l=o-(s=e),h=0):2===u?(l=o-(s=n),h=o-(c=e)):3===u?(s=e,l=0,h=o-(c=n)):(s=n,c=e,h=l=0);var d=k(s,c);d.getContext("2d").drawImage(r,l,h,s,c,0,0,s,c);var p=d.toDataURL(f);"function"==typeof m&&m(p,s,c)})}},{key:"addMark",value:function(i,n){var e=this;if("function"!=typeof n)return!1;"canvas"!==i.nodeName.toLowerCase()&&(i=k(i.width,i.height));var o=i.getContext("2d");this.hasMark?this.markIcon?r(this.markIcon,function(t){e.markX||(e.markX=e.cropW-t.naturalWidth),e.markY||(e.markY=e.cropH-t.naturalHeight),o.drawImage(t,e.markX,e.markY),n(i)}):(o.textAlign="end",o.font=this.markFont,o.fillStyle=this.markStyle,this.markX||(this.markX=this.cropW-10),this.markY||(this.markY=this.cropH-10),o.fillText(this.markText,this.markX,this.markY),n(i)):n(i)}},{key:"preview",value:function(t){this.$previewContainer&&(this.$previewContainer.innerHTML='<img src="'+t+'">')}},{key:"download",value:function(t){"download"in document.createElement("a")&&this.$downloadBtn&&(this.$downloadBtn.download=(new Date).valueOf()+"_dest."+this.mime.substr(this.mime.indexOf("image/")+6),this.$downloadBtn.href=t)}},{key:"crop",value:function(t,i,n,e,o,r,a,s,c){var l=this;if(t){var h=k(s,c);h.getContext("2d").drawImage(t,i,n,e,o,r,a,s,c),this.addMark(h,function(t){var i=t.toDataURL(l.mime);l.preview(i),l.download(i),"function"==typeof l.onCropped&&l.onCropped(i)})}}},{key:"init",value:function(){var r=this,a=void 0,e=void 0,s=void 0,o=void 0,c=void 0,i=void 0,l=(this.containerSize-this.cropW)/2,h=(this.containerSize-this.cropH)/2;this.$workingContainer.innerHTML='<div class="working-area"><img><div class="mask"></div></div>',this.$workingContainer.querySelector(".working-area").style.cssText="position: relative;overflow: hidden;width: "+this.containerSize+"px;height: "+this.containerSize+"px;",(a=this.$workingContainer.querySelector("img")).style.position="absolute",this.$workingContainer.querySelector(".mask").style.cssText="position: absolute;width: "+this.cropW+"px;height: "+this.cropH+"px;border-left: "+l+"px solid "+this.maskColor+";border-right: "+l+"px solid "+this.maskColor+";border-top: "+h+"px solid "+this.maskColor+";border-bottom: "+h+"px solid "+this.maskColor+";",function(e,t,o){if(e){var r=!1,a=void 0,s=void 0,c=void 0,l=void 0,h=void 0,d=void 0;window.addEventListener&&((t=t||document).addEventListener("mousedown",function(t){t=t||window.event,a=t.clientX,s=t.clientY;var i=e.getBoundingClientRect();c=i.left,l=i.top,r=!0},!1),document.addEventListener("mousemove",function(t){if(t=t||window.event,r){var i=t.clientX,n=t.clientY;h=i-a+c,d=n-s+l,e.style.left=h,e.style.top=d,"function"==typeof o&&o(h,d)}},!1),document.addEventListener("mouseup",function(t){r=!1},!1))}}(a,this.$workingContainer);a.addEventListener("load",function(){e=a.naturalWidth,s=a.naturalHeight;var t=e/s,i=0,n=0;1<t?(o=r.containerSize,c=o/t,i=(r.containerSize-c)/2,n=0):(c=r.containerSize,o=c*t,n=(r.containerSize-o)/2,i=0),a.style.cssText="position: absolute;width: "+o+"px;height: "+c+"px;top: "+i+"px;left: "+n+"px;"},!1),this.$selectBtn.addEventListener("click",function(t){!function(t,o,r){var i="string"==typeof t?document.querySelector(t):t,n=i.querySelector("input[type=file]");if(!n){var e=document.createElement("input");e.setAttribute("type","file"),e.style.cssText="display: none;",i.appendChild(e),n=i.querySelector("input[type=file]")}n.addEventListener("change",function(t){if(0<this.files.length){var i=this.files[0],n=!0;if("function"==typeof r&&!1===r(i)&&(n=!1),n){var e=new FileReader;e.readAsDataURL(i),e.onload=function(){"function"==typeof o&&o(this.result)}}else console.log("onValidateFile function return false")}},!1),n.addEventListener("click",function(t){t.stopPropagation()}),n.click()}(r.$selectBtn,function(t){a.src=t,a.style.width="auto",a.style.height="auto",i=t},r.onValidateFile)},!1);var t=function(t){var i=e/s;c+=r.scaleStep*t,o=c*i,a.style.width=o+"px",a.style.height=c+"px"};this.$downBtn.addEventListener("click",function(){t(-1)},!1),this.$upBtn.addEventListener("click",function(){t(1)},!1),this.$cropBtn.addEventListener("click",function(){var t=s/c,i=(h-a.offsetTop)*t,n=(l-a.offsetLeft)*t,e=r.cropW*t,o=r.cropH*t;r.crop(a,n,i,e,o,0,0,r.cropW,r.cropH)},!1),this.$clockwiseBtn.addEventListener("click",function(){var t=r.getRotateNum(1);r.rotate(i,t,r.mime,function(t,i,n){a.src=t})},!1),this.$anticlockwiseBtn.addEventListener("click",function(){var t=r.getRotateNum(-1);r.rotate(i,t,r.mime,function(t,i,n){a.src=t})},!1)}}]),i}();t.PipeImg=i}(window);