"use strict";var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e};!function(Y,M){void 0!==Y&&(Y.pipeImg=function(e){var t={selectBtn:M.querySelector("#J-select-btn"),upBtn:M.querySelector("#J-up-btn"),downBtn:M.querySelector("#J-down-btn"),cropBtn:M.querySelector("#J-crop-btn"),downloadBtn:M.querySelector("#J-download-btn"),workingContainer:M.querySelector("#J-working-container"),previewContainer:M.querySelector("#J-preview-container"),scaleStep:10,containerSize:500,cropSize:300,cropImgType:"image/png",borderColor:"rgba(0, 0, 0, 0.8)",hasWatermark:!0,watermarkImg:null,watermarkFont:"16px microsoft yahei",watermarkFillStyle:"#fff",watermarkFillText:"UED",watermarkX:0,watermarkY:0,onValidateFile:function(e){return!0},onCropped:function(e){}},n=_extends({},t,e),r=n.selectBtn,o=n.upBtn,i=n.downBtn,a=n.cropBtn,c=n.downloadBtn,l=n.workingContainer,s=n.previewContainer,d=n.scaleStep,u=n.containerSize,f=n.cropSize<=u?n.cropSize:u,p=n.cropImgType,w=(n.containerSize-n.cropSize)/2,v=n.borderColor,m=n.hasWatermark,g=n.watermarkImg,h=n.watermarkFont,y=n.watermarkFillStyle,k=n.watermarkFillText,x=n.watermarkX?n.watermarkX:f-10,S=n.watermarkY?n.watermarkY:f-10,b=n.onValidateFile,E=n.onCropped,L=void 0,I=0,q=0,C=0,T=0,B=0,F=void 0,J=0;function z(e){return(3<(J+=e)||J<-3)&&(J=0),J<0?4+J:J}function D(e,t){var n=M.createElement("canvas");return n.width=e,n.height=t,n}function H(){q=L.naturalWidth,C=L.naturalHeight;var e=0,t=0;1<=(I=q/C)?(e=w,t=(u-(T=(B=f)*I))/2):(t=w,e=(u-(B=(T=f)/I))/2),L.style.cssText="position: absolute;width: "+T+"px;height: "+B+"px;top: "+e+"px;left: "+t+"px;"}function O(e){T=(B+=d*e)*I,L.style.width=T+"px",L.style.height=B+"px"}function W(e,p,w,v){var t,n,r;t=e,n=function(e){var t=90*p,n=e.naturalWidth,r=e.naturalHeight,o=Math.max(n,r),i=D(o,o),a=i.getContext("2d");a.translate(o/2,o/2),a.rotate(t*Math.PI/180),a.translate(-o/2,-o/2),a.drawImage(e,0,0);var l=n,c=r,s=0,d=0;1===p?(c=n,s=o-(l=r),d=0):2===p?(s=o-(l=n),d=o-(c=r)):3===p?(l=r,s=0,d=o-(c=n)):(l=n,c=r,d=s=0);var u=D(l,c);u.getContext("2d").drawImage(i,s,d,l,c,0,0,l,c);var f=u.toDataURL(w);v&&"function"==typeof v&&v(f,l,c)},(r=new Image).src=t,r.onload=function(){n(r)},r.onerror=function(){console.log("Error: image error!")}}function X(){if(L.src){var e,t,n=(w-L.offsetTop)/B*C,r=(w-L.offsetLeft)/T*q;e=t=f/B*C;var o=D(f,f),i=o.getContext("2d");if(i.drawImage(L,r,n,e,t,0,0,f,f),m)if(g){var a=new Image;a.setAttribute("crossorigin","anonymous"),a.onload=function(){x=f-a.naturalWidth,S=f-a.naturalHeight,i.drawImage(a,x,S),l()},a.src=g}else i.textAlign="end",i.font=h,i.fillStyle=y,i.fillText(k,x,S),l();else l()}function l(){var e=o.toDataURL(p);s.innerHTML='<img src="'+e+'">',"download"in M.createElement("a")&&(c.download=(new Date).valueOf()+"_dest."+p.substr(p.indexOf("image/")+6),c.href=e),E(e)}}!function(){if(E&&"function"!=typeof E)throw new Error("onCropped必须为函数");if(b&&"function"!=typeof b)throw new Error("onValidateFile必须为函数");l.innerHTML='<div class="working-area"><img><div class="mask"></div></div><input type="file" hidden>',l.querySelector(".working-area").style.cssText="position: relative;overflow: hidden;width: "+u+"px;height: "+u+"px;",(L=l.querySelector("img")).style.position="absolute",l.querySelector(".mask").style.cssText="position: absolute;width: "+f+"px;height: "+f+"px;border: "+w+"px solid "+v+";",function(e,i,a){if(e&&i){var l,c,t=function(e,t){return e.currentStyle?e.currentStyle[t]:getComputedStyle(e,null)[t]},s=t(i,"left"),d=t(i,"top"),u=!1;Y.addEventListener&&(e.addEventListener("mousedown",function(e){var e=e||Y.event;l=e.clientX,c=e.clientY,u=!0},!1),M.addEventListener("mousemove",function(e){var e=e||Y.event;if(u){var t=e.clientX,n=e.clientY,r=t-l,o=n-c;return i.style.left=parseInt(s)+r+"px",i.style.top=parseInt(d)+o+"px","function"==typeof a&&a((parseInt(s)||0)+r,(parseInt(d)||0)+o),!1}},!1),M.addEventListener("mouseup",function(e){u=!1,s=t(i,"left"),d=t(i,"top")},!1))}}(l,L),L.addEventListener("load",H,!1),r.addEventListener("click",function(){var e=l.querySelector("input[type=file]");e.addEventListener("change",function(){if(0<this.files.length){var e=this.files[0];if(0!=b(e)){var t=new FileReader;t.readAsDataURL(e),t.onload=function(){L.src=this.result,L.style.width="auto",L.style.height="auto",F=this.result}}}},!1),e.click()},!1),i.addEventListener("click",function(){O(-1)},!1),o.addEventListener("click",function(){O(1)},!1),a.addEventListener("click",X,!1),M.querySelector("#J-clockwise-btn").addEventListener("click",function(){var e=z(1);W(F,e,p,function(e,t,n){L.src=e})},!1),M.querySelector("#J-anticlockwise-btn").addEventListener("click",function(){var e=z(-1);W(F,e,p,function(e,t,n){L.src=e})},!1)}()})}(window,document);