"use strict";var _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var o=arguments[e];for(var i in o)Object.prototype.hasOwnProperty.call(o,i)&&(t[i]=o[i])}return t},_createClass=function(){function i(t,e){for(var o=0;o<e.length;o++){var i=e[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,o){return e&&i(t.prototype,e),o&&i(t,o),t}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function drag(t,r,s){if(!t||!r)return!1;var a,c,e=function(t,e){return t.currentStyle?t.currentStyle[e]:getComputedStyle(t,null)[e]},h=e(r,"left"),l=e(r,"top"),u=!1;window.addEventListener&&(t.addEventListener("mousedown",function(t){t=t||window.event;a=t.clientX,c=t.clientY,u=!0},!1),document.addEventListener("mousemove",function(t){t=t||window.event;if(u){var e=t.clientX,o=t.clientY,i=e-a,n=o-c;return r.style.left=parseInt(h)+i+"px",r.style.top=parseInt(l)+n+"px","function"==typeof s&&s((parseInt(h)||0)+i,(parseInt(l)||0)+n),!1}},!1),document.addEventListener("mouseup",function(t){u=!1,h=e(r,"left"),l=e(r,"top")},!1))}function selector(t){return"string"==typeof t?document.querySelector(t):t}function loadImage(t,e){var o=new Image;o.setAttribute("crossorigin","anonymous"),o.src=t,o.onload=function(){e(o)},o.onerror=function(){console.log("Error: image error!")}}function getCanvas(t,e){var o=document.createElement("canvas");return o.width=t,o.height=e,o}function chooseFile(t,i,n){var e="string"==typeof t?document.querySelector(t):t,o=e.querySelector("input[type=file]");if(!o){var r=document.createElement("input");r.setAttribute("type","file"),r.style.cssText="display: none;",e.appendChild(r),o=e.querySelector("input[type=file]")}o.addEventListener("change",function(){if(0<this.files.length){var t=this.files[0],e=!0;if(n&&"function"==typeof n&&!1===n(t)&&(e=!1),e){var o=new FileReader;o.readAsDataURL(t),o.onload=function(){i&&"function"==typeof i&&i(this.result)}}}},!1),o.click()}var defaultProps={selectBtn:"#J-select-btn",upBtn:"#J-up-btn",downBtn:"#J-down-btn",anticlockwiseBtn:"#J-anticlockwise-btn",clockwiseBtn:"#J-clockwise-btn",cropBtn:"#J-crop-btn",downloadBtn:"#J-download-btn",workingContainer:"#J-working-container",previewContainer:"#J-preview-container",scaleStep:10,containerSize:500,cropSize:300,cropImgType:"image/png",borderColor:"rgba(0, 0, 0, 0.8)",hasMark:!0,markIcon:null,markFont:"16px microsoft yahei",markStyle:"#fff",markText:"UED",markX:0,markY:0,onValidateFile:function(t){return!0},onCropped:function(t){}},PipeImg=function(){function e(t){_classCallCheck(this,e),this.options=_extends(defaultProps,t),this.$selectBtn=selector(this.options.selectBtn),this.$upBtn=selector(this.options.upBtn),this.$downBtn=selector(this.options.downBtn),this.$anticlockwiseBtn=selector(this.options.anticlockwiseBtn),this.$clockwiseBtn=selector(this.options.clockwiseBtn),this.$cropBtn=selector(this.options.cropBtn),this.$downloadBtn=selector(this.options.downloadBtn),this.$workingContainer=selector(this.options.workingContainer),this.$previewContainer=selector(this.options.previewContainer),this.scaleStep=this.options.scaleStep,this.containerSize=this.options.containerSize,this.cropSize=this.options.cropSize<=this.containerSize?this.options.cropSize:this.containerSize,this.cropImgType=this.options.cropImgType,this.borderWidth=(this.containerSize-this.cropSize)/2,this.borderColor=this.options.borderColor,this.hasMark=this.options.hasMark,this.markIcon=this.options.markIcon,this.markFont=this.options.markFont,this.markStyle=this.options.markStyle,this.markText=this.options.markText,this.markX=this.options.markX,this.markY=this.options.markY,this.onValidateFile=this.options.onValidateFile,this.onCropped=this.options.onCropped,this.sourceImgEle=void 0,this.sourceRatio=0,this.sourceW0=0,this.sourceH0=0,this.sourceW1=0,this.sourceH1=0,this.cacheSource="",this.rotateCount=0,this.init()}return _createClass(e,[{key:"getRotateNum",value:function(t){return this.rotateCount+=t,(3<this.rotateCount||this.rotateCount<-3)&&(this.rotateCount=0),this.rotateCount<0?4+this.rotateCount:this.rotateCount}},{key:"scaleImg",value:function(t){this.sourceH1+=this.scaleStep*t,this.sourceW1=this.sourceH1*this.sourceRatio,this.sourceImgEle.style.width=this.sourceW1+"px",this.sourceImgEle.style.height=this.sourceH1+"px"}},{key:"rotate",value:function(t,d,m,f){loadImage(t,function(t){var e=90*d,o=t.naturalWidth,i=t.naturalHeight,n=Math.max(o,i),r=getCanvas(n,n),s=r.getContext("2d");s.translate(n/2,n/2),s.rotate(e*Math.PI/180),s.translate(-n/2,-n/2),s.drawImage(t,0,0);var a=o,c=i,h=0,l=0;1===d?(c=o,h=n-(a=i),l=0):2===d?(h=n-(a=o),l=n-(c=i)):3===d?(a=i,h=0,l=n-(c=o)):(a=o,c=i,l=h=0);var u=getCanvas(a,c);u.getContext("2d").drawImage(r,h,l,a,c,0,0,a,c);var p=u.toDataURL(m);f&&"function"==typeof f&&f(p,a,c)})}},{key:"watermark",value:function(e,o){var i=this;"canvas"!==e.nodeName.toLowerCase()&&(e=getCanvas(e.width,e.height));var n=e.getContext("2d");this.hasMark?this.markIcon?loadImage(this.markIcon,function(t){i.markX||(i.markX=i.cropSize-t.naturalWidth),i.markY||(i.markY=i.cropSize-t.naturalHeight),n.drawImage(t,i.markX,i.markY),o(e)}):(n.textAlign="end",n.font=this.markFont,n.fillStyle=this.markStyle,this.markX||(this.markX=this.cropSize-10),this.markY||(this.markY=this.cropSize-10),n.fillText(this.markText,this.markX,this.markY),o(e)):o(e)}},{key:"preview",value:function(t){this.$previewContainer&&(this.$previewContainer.innerHTML='<img src="'+t+'">')}},{key:"download",value:function(t){"download"in document.createElement("a")&&this.$downloadBtn&&(this.$downloadBtn.download=(new Date).valueOf()+"_dest."+this.cropImgType.substr(this.cropImgType.indexOf("image/")+6),this.$downloadBtn.href=t)}},{key:"crop",value:function(){var o=this;if(this.sourceImgEle.src){var t,e,i=(this.borderWidth-this.sourceImgEle.offsetTop)/this.sourceH1*this.sourceH0,n=(this.borderWidth-this.sourceImgEle.offsetLeft)/this.sourceW1*this.sourceW0;t=e=this.cropSize/this.sourceH1*this.sourceH0;var r=getCanvas(this.cropSize,this.cropSize);r.getContext("2d").drawImage(this.sourceImgEle,n,i,t,e,0,0,this.cropSize,this.cropSize),this.watermark(r,function(t){var e=(r=t).toDataURL(o.cropImgType);o.preview(e),o.download(e),o.onCropped(e)})}}},{key:"loadHandler",value:function(){var t=this;t.sourceW0=t.sourceImgEle.naturalWidth,t.sourceH0=t.sourceImgEle.naturalHeight,t.sourceRatio=t.sourceW0/t.sourceH0;var e=0,o=0;1<=t.sourceRatio?(t.sourceW1=t.cropSize*t.sourceRatio,t.sourceH1=t.cropSize,e=t.borderWidth,o=(t.containerSize-t.sourceW1)/2):(t.sourceH1=t.cropSize/t.sourceRatio,t.sourceW1=t.cropSize,o=t.borderWidth,e=(t.containerSize-t.sourceH1)/2),t.sourceImgEle.style.cssText="position: absolute;width: "+t.sourceW1+"px;height: "+t.sourceH1+"px;top: "+e+"px;left: "+o+"px;"}},{key:"init",value:function(){var i=this,e=this;if(this.onCropped&&"function"!=typeof this.onCropped)throw new Error("onCropped必须为函数");if(this.onValidateFile&&"function"!=typeof this.onValidateFile)throw new Error("onValidateFile必须为函数");this.$workingContainer.innerHTML='<div class="working-area"><img><div class="mask"></div></div>',this.$workingContainer.querySelector(".working-area").style.cssText="position: relative;overflow: hidden;width: "+this.containerSize+"px;height: "+this.containerSize+"px;",this.sourceImgEle=this.$workingContainer.querySelector("img"),this.sourceImgEle.style.position="absolute",this.$workingContainer.querySelector(".mask").style.cssText="position: absolute;width: "+this.cropSize+"px;height: "+this.cropSize+"px;border: "+this.borderWidth+"px solid "+this.borderColor+";",drag(this.$workingContainer,this.sourceImgEle),this.sourceImgEle.addEventListener("load",function(){i.loadHandler()},!1),this.$selectBtn.addEventListener("click",function(){chooseFile(i.$selectBtn,function(t){e.sourceImgEle.src=t,e.sourceImgEle.style.width="auto",e.sourceImgEle.style.height="auto",e.cacheSource=t})},!1),this.$downBtn.addEventListener("click",function(){i.scaleImg(-1)},!1),this.$upBtn.addEventListener("click",function(){i.scaleImg(1)},!1),this.$cropBtn.addEventListener("click",function(){i.crop()},!1),this.$clockwiseBtn.addEventListener("click",function(){var t=i.getRotateNum(1);i.rotate(i.cacheSource,t,i.cropImgType,function(t,e,o){i.sourceImgEle.src=t})},!1),this.$anticlockwiseBtn.addEventListener("click",function(){var t=i.getRotateNum(-1);i.rotate(i.cacheSource,t,i.cropImgType,function(t,e,o){i.sourceImgEle.src=t})},!1)}}]),e}();"undefined"!=typeof window&&(window.PipeImg=PipeImg),"undefined"!=typeof exports&&(exports.PipeImg=PipeImg);